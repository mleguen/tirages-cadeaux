version: '3.8'

volumes:
    cache:
    doctrine:
services:
    mailhog:
        image: mailhog/mailhog
        ports:
            - 8025:8025
    mysql:
        environment:
            MYSQL_DATABASE: tkdo
            MYSQL_USER: tkdo
            MYSQL_PASSWORD: mdptkdo
            MYSQL_ROOT_PASSWORD: mdproot
        image: mysql:5.6
    slim:
        build: ./build-slim
        depends_on:
            - mailhog
            - mysql
        environment:
            docker: "true"
            MHSENDMAIL_OPTIONS: --smtp-addr=mailhog:1025
            MYSQL_DATABASE: tkdo
            MYSQL_HOST: mysql
            MYSQL_PASSWORD: mdptkdo
            MYSQL_PORT: 3306
            MYSQL_USER: tkdo
            TKDO_BASE_URI: http://slim
            TKDO_COMPILE_CONTAINER: 0
            TKDO_DEV_MODE: 0
            TKDO_MAILER_FROM: noreply@slim
        volumes:
            - ../public:/var/www/html/api/public
            - ../src:/var/www/html/api/src
            - ../var/auth:/var/www/html/api/var/auth
            - cache:/var/www/html/api/var/cache
            - doctrine:/var/www/html/api/var/doctrine
            - ../vendor:/var/www/html/api/vendor
            - ../.env:/var/www/html/api/.env
    phpunit:
        build: ./build-phpunit
        depends_on:
            - mysql
            - slim
        environment:
            docker: "true"
            MAILHOG_BASE_URI: http://mailhog:8025/
            MHSENDMAIL_OPTIONS: --smtp-addr=mailhog:1025
            MYSQL_DATABASE: tkdo
            MYSQL_HOST: mysql
            MYSQL_PASSWORD: mdptkdo
            MYSQL_PORT: 3306
            MYSQL_USER: tkdo
            TKDO_BASE_URI: http://slim
            TKDO_COMPILE_CONTAINER: 0
            TKDO_DEV_MODE: 0
            TKDO_MAILER_FROM: noreply@slim
        restart: 'no'
        volumes:
            - ../bin:/usr/src/tkdo/bin
            - ../src:/usr/src/tkdo/src
            - ../test:/usr/src/tkdo/test
            - ../var/auth:/usr/src/tkdo/var/auth
            - cache:/usr/src/tkdo/var/cache
            - doctrine:/usr/src/tkdo/var/doctrine
            - ../vendor:/usr/src/tkdo/vendor
            - ../.env:/usr/src/tkdo/.env
            - ../cli-config.php:/usr/src/tkdo/cli-config.php
            - ../composer.json:/usr/src/tkdo/composer.json
            - ../composer.phar:/usr/src/tkdo/composer.phar
            - ../phpunit.xml:/usr/src/tkdo/phpunit.xml
            - ./build-phpunit/startup.sh:/usr/src/tkdo/startup.sh
